; ============================================================
; Asterisk Dialplan fÃ¼r KI-Telefonassistent
; ============================================================

[general]
static=yes
writeprotect=no

[globals]
RECORD_DIR=/opt/ki-telefonassistent/recordings
AUDIO_DIR=/opt/ki-telefonassistent/audio
AGI_SCRIPT=/opt/ki-telefonassistent/venv/bin/python /opt/ki-telefonassistent/src/agi_handler.py

; ============================================================
; Eingehende Anrufe
; ============================================================
[eingehend]
; Alle eingehenden Anrufe
exten => _X.,1,NoOp(=== Eingehender Anruf von ${CALLERID(num)} ===)
 same => n,Set(CALL_ID=${EPOCH}${RAND(1000,9999)})
 same => n,Set(CHANNEL(language)=de)
 ; AGI bei Hangup NICHT sofort abbrechen - Python-Skript braucht Zeit
 same => n,Set(CHANNEL(hangup_handler_push)=eingehend-cleanup,s,1)
 same => n,Answer()
 same => n,Wait(1)
 ; Aufnahme starten
 same => n,MixMonitor(${RECORD_DIR}/${CALL_ID}.wav,b)
 ; AGI-Skript aufrufen (hier passiert die KI-Magie)
 same => n,AGI(${AGI_SCRIPT},${CALL_ID},${CALLERID(num)})
 ; Aufnahme stoppen und auflegen
 same => n,StopMixMonitor()
 same => n,Hangup()

; Cleanup-Handler bei Hangup
[eingehend-cleanup]
exten => s,1,NoOp(=== Hangup-Handler: Aufraeumen ===)
 same => n,StopMixMonitor()
 same => n,Return()

; Fallback wenn keine Extension passt
exten => _.,1,NoOp(Unbekannte Extension: ${EXTEN})
 same => n,Answer()
 same => n,Wait(1)
 same => n,AGI(${AGI_SCRIPT},fallback,${CALLERID(num)})
 same => n,Hangup()

; ============================================================
; Standard-Kontext (Sicherheit)
; ============================================================
[default]
exten => _X.,1,NoOp(Anruf im Default-Kontext abgelehnt)
 same => n,Hangup()
